<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tabla de Clasificación | Torneo de Youtubers CoD Mobile</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background-color: #121212;
      color: #7e7e7e;
      font-family: 'Arial', sans-serif;
      padding-top: 20px;
      margin: 0;
      position: relative;
      overflow-x: hidden;
      min-height: 100vh;
    }

    body::before {
      content: "";
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image: url('https://r2.fivemanage.com/XTC0OA0z5LKkI1Ialy4w2/WhatsAppImage2025-10-06at2.15.48PM.jpeg');
      background-size: cover;
      background-position: center;
      filter: brightness(30%) blur(2px);
      z-index: -1;
    }

    main, header {
      position: relative;
      z-index: 1;
    }

    .header-bg {
      background-color: rgba(0, 0, 0, 0.6);
      padding: 20px 0;
      margin-bottom: 40px;
      border-bottom: 3px solid #FFC107;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.6);
    }

    .tournament-logo {
      max-height: 100px;
      width: auto;
      display: block;
      margin: 0 auto;
    }

    .scoreboard-title {
      color: #FFC107;
      font-weight: 900;
      text-transform: uppercase;
      letter-spacing: 3px;
      text-shadow: 1px 1px 5px rgba(0, 0, 0, 1);
      margin-top: 15px;
      font-size: 2.5rem;
    }

    #leaderboard-container {
      background-color: rgba(0, 0, 0, 0.7);
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 20px rgba(255, 193, 7, 0.3);
      overflow-x: auto;
    }

    .table-custom {
      --bs-table-bg: transparent;
      --bs-table-color: #969696;
      --bs-table-border-color: #444;
      font-size: 1.2rem;
    }

    .table-custom th {
      color: #FFC107;
      border-bottom: 3px solid #FFC107;
      text-transform: uppercase;
      font-size: 1rem;
      padding: 1rem 0.5rem;
      text-align: center;
    }

    .table-custom td {
      padding: 0.8rem 0.5rem;
      vertical-align: middle;
      text-align: center;
    }

    .table-custom tr:nth-child(even) {
      background-color: rgba(255, 255, 255, 0.05);
    }

    .table-custom td:first-child {
      font-weight: bold;
      color: #505050;
      font-size: 1.3rem;
    }

    /* TOP 3 coloreados correctamente (solo en tbody) */
    .table-custom tbody tr:nth-child(1) td { color: gold; font-weight: bold; }
    .table-custom tbody tr:nth-child(2) td { color: silver; font-weight: bold; }
    .table-custom tbody tr:nth-child(3) td { color: #aa6321; font-weight: bold; }

    .text-muted {
      color: rgba(255, 255, 255, 0.5) !important;
    }
  </style>
</head>
<body>

  <header class="header-bg">
    <div class="container text-center">
      <img src="https://r2.fivemanage.com/XTC0OA0z5LKkI1Ialy4w2/logooficial.png"
           alt="Logo del Torneo" class="tournament-logo">
      <h1 class="scoreboard-title">TABLA DE PUNTAJES OFICIAL</h1>
    </div>
  </header>

  <main class="container">
    <div class="row justify-content-center">
      <div class="col-12 col-xl-8">
        <div class="alert alert-info text-center" role="alert" id="loading-message">
          Cargando clasificación...
        </div>

        <div id="leaderboard-container"></div>
      </div>
    </div>

    <div class="text-center mt-5 mb-3 text-muted">
      <small>Torneo de Youtubers CoD Mobile. Los puntajes se actualizan al editar la hoja de cálculo.</small>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    const SPREADSHEET_URL_BASE = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR9_-sFuodCsbmOWmGSLmHx17etlF5jdl8bo_fy5nPPQ9NFcZCfr1xmMf_K31962J0GIXcpmokAXIJ6/pub?gid=591116041&single=true&output=csv';
    const MAX_ROWS_DISPLAY = 10;

    const container = document.getElementById('leaderboard-container');
    const loadingMessage = document.getElementById('loading-message');

    function csvToArray(text) {
      let p = '';
      let row = [''];
      let ret = [row];
      let i = 0;
      let r = 0;
      let s = true;
      for (let j = 0; j < text.length; j++) {
        let c = text[j];
        if (c === '"' && s) s = !s;
        else if (c === '"' && !s) {
          if (text[j + 1] === '"') {
            row[i] += c;
            j++;
          } else s = !s;
        } else if (c === ',' && s) c = row[++i] = '';
        else if (c === '\n' && s) {
          if (text[j - 1] === '\r') row[i] = row[i].slice(0, -1);
          row = ret[++r] = [''];
          i = 0;
        } else row[i] += c;
      }
      return ret.filter(r => r[0] !== '');
    }

    function getTotalScoreColumnIndex(headers) {
      // Buscar la columna que contiene el puntaje total
      // Puede tener diferentes nombres, así que buscamos varias posibilidades
      const possibleNames = ['total', 'puntaje total', 'total score', 'puntos totales', 'puntaje'];
      
      for (let i = 0; i < headers.length; i++) {
        const header = headers[i].toLowerCase().trim();
        if (possibleNames.some(name => header.includes(name))) {
          return i;
        }
      }
      
      // Si no encontramos ninguna coincidencia, asumimos que es la última columna
      return headers.length - 1;
    }

    function sortRowsByTotalScore(rows, totalScoreColumnIndex) {
      return rows.sort((a, b) => {
        // Convertir a número para comparar correctamente
        const scoreA = parseFloat(a[totalScoreColumnIndex]) || 0;
        const scoreB = parseFloat(b[totalScoreColumnIndex]) || 0;
        return scoreB - scoreA; // Orden descendente
      });
    }

    function getLugarText(position) {
      switch (position) {
        case 1: return '1er Lugar';
        case 2: return '2do Lugar';
        case 3: return '3er Lugar';
        case 4: return '4to Lugar';
        case 5: return '5to Lugar';
        case 6: return '6to Lugar';
        case 7: return '7mo Lugar';
        case 8: return '8vo Lugar';
        case 9: return '9no Lugar';
        case 10: return '10mo Lugar';
        default: return position + '° Lugar';
      }
    }

    async function loadLeaderboard() {
      const cacheBuster = `&t=${new Date().getTime()}`;
      const finalSpreadsheetUrl = SPREADSHEET_URL_BASE + cacheBuster;
      const CSV_URL = 'https://api.allorigins.win/raw?url=' + encodeURIComponent(finalSpreadsheetUrl);

      try {
        const response = await fetch(CSV_URL);
        const csvText = await response.text();
        const data = csvToArray(csvText);

        loadingMessage.style.display = 'none';

        if (data.length <= 1) {
          container.innerHTML = '<div class="alert alert-warning">No se encontraron datos de clasificación.</div>';
          return;
        }

        // Obtener encabezados
        const headers = data[0];
        
        // Identificar la columna de puntaje total
        const totalScoreColumnIndex = getTotalScoreColumnIndex(headers);
        
        // Obtener todas las filas de datos (excluyendo encabezados)
        const allRows = data.slice(1);
        
        // Ordenar filas por puntaje total descendente
        const sortedRows = sortRowsByTotalScore(allRows, totalScoreColumnIndex);
        
        // Tomar solo las primeras MAX_ROWS_DISPLAY filas
        const rowsToDisplay = sortedRows.slice(0, MAX_ROWS_DISPLAY);

        let html = '<table class="table table-custom"><thead><tr>';

        // Agregar encabezados originales + columna "LUGAR"
        const displayHeaders = ['LUGAR', ...headers];
        displayHeaders.forEach(header => {
          html += `<th scope="col">${header.trim().toUpperCase()}</th>`;
        });
        html += '</tr></thead><tbody>';

        // Mostrar las filas ordenadas
        for (let i = 0; i < rowsToDisplay.length; i++) {
          const row = rowsToDisplay[i];
          const lugarText = getLugarText(i + 1);

          html += `<tr>`;
          html += `<td class="fw-bold">${lugarText}</td>`;

          row.forEach((cell, cellIndex) => {
            let cellClass = '';
            if (i === 0 && cellIndex !== 0) {
              cellClass += ' text-warning';
            } else if (i === 1 && cellIndex !== 0) {
              cellClass += ' silver';
            } else if (i === 2 && cellIndex !== 0) {
              cellClass += ' #aa6321';
            }
            html += `<td class="${cellClass}">${cell.trim()}</td>`;
          });
          html += `</tr>`;
        }

        html += '</tbody></table>';
        container.innerHTML = html;

      } catch (error) {
        console.error("Error al cargar la clasificación:", error);
        loadingMessage.className = 'alert alert-danger text-center';
        loadingMessage.innerHTML = 'Error al cargar la clasificación. Verifica la URL o los permisos.';
        loadingMessage.style.display = 'block';
      }
    }

    loadLeaderboard();
    // setInterval(loadLeaderboard, 30000);
  </script>
</body>
</html>
